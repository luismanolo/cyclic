<template>
  <div id="mapContainer">
    <l-map ref="map" @move="log('move')" v-model:zoom="zoom" :center="center" :use-global-leaflet="false">
      <l-tile-layer url="http://tile.stamen.com/watercolor/{z}/{x}/{y}.jpg" layer-type="base" name="Stamen Watercolor"
        attribution="Map tiles by <a href='http://stamen.com'>Stamen Design</a>, under <a href='http://creativecommons.org/licenses/by/3.0'>CC BY 3.0</a>. Data by <a href='http://openstreetmap.org'>OpenStreetMap</a>, under <a href='http://creativecommons.org/licenses/by-sa/3.0'>CC BY SA</a>." />

      <l-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" layer-type="base"
        name="OpenStreetMap"></l-tile-layer>

      <l-geo-json v-for="data in geojsonLayers" :options="data.options" :geojson="data.json" :name="data.name" layer-type="overlay">
      </l-geo-json>

      <l-control-layers />
    </l-map>
  </div>
</template>

<script>
import "leaflet/dist/leaflet.css";
import { LMap, LTileLayer, LControlLayers, LGeoJson, LPopup } from "@vue-leaflet/vue-leaflet";
import { mapStore } from '@store/mapStore.js'
const mapData = mapStore();

export default {
  components: {
    LMap,
    LTileLayer,
    LControlLayers,
    LGeoJson,
    LPopup
  },
  data() {
    return {
      zoom: 14,
      center: [42.5602081, -2.7601252],
      geojsonLayers: []
    };
  },
  computed: {
  },
  async created() {
    // const municipios = {
    //   url: "https://raw.githubusercontent.com/iderioja/base_datos_geografica/master/municipios.json",
    //   name: "Municipios La Rioja"
    // };
    const municipios = mapData.jsonLayers[0];
    const res = await fetch(municipios.url)
    const jsonData = await res.json();
    this.geojsonLayers.push({
      json: jsonData,
      name: municipios.name,
      options: {
        onEachFeature: this.onEachFeatureJSON,
        mouseover: this.mouseOverJSON
      }
    });
  },
  methods: {
    log(a) {
      console.log(a);
    },
    filterFeatureJSON() {
      return true;
    },
    mouseOverJSON(feature) {
      feature.openTooltip();
    },
    onEachFeatureJSON(feature, layer) {
      console.log("Municipio");
      console.log(feature.properties.NOMBRE_MUNICIPIO);
      layer.bindPopup(`${feature.properties.NOMBRE_MUNICIPIO} (${feature.properties.NOMBRE_PROVINCIA})`)
      layer.bindTooltip(`${feature.properties.NOMBRE_MUNICIPIO}`, {sticky: true})
      // if (feature.properties && feature.properties.NOMBRE_MUNICIPIO) {
      //   layer.bindPopup(feature.properties.NOMBRE_MUNICIPIO);
      //   layer.on('mouseover', () => { layer.openPopup(); });
      //   layer.on('mouseout', () => { layer.closePopup(); });
      // }
    }
  }
};
</script>

<style>
#mapContainer {
  width: calc(100vw - 15px);
  height: calc(100vh - 65px);
}
</style>
